# Maintainer: irmluity <45vw4yz8g@mozmail.com>

pkgname=hiddify.next
pkgver=0.10.7.dev
pkgrel=1
pkgdesc="A multi-platform proxy app. Auto, SSH, VLESS, Vmess, Trojan, Reality, Sing-Box, Clash, Xray, Shadowsocks"
arch=(x86_64)
url='https://github.com/hiddify/hiddify-next'
license=('CCPL')
depends=('hicolor-icon-theme' 'zlib' 'glibc' 'fuse2')
makedepends=('cmake' 'clang' 'locate' 'ninja' 'pkg-config' 'gtk3' 'glib2' 'libayatana-appindicator' 'libayatana-indicator' 'libayatana-common' 'libappindicator-gtk3' 'libappindicator-gtk2' 'fuse2' 'fuse3' 'appimagetool-bin')
optdepends=(
    'gnome-shell-extension-appindicator: for system tray icon if you are using Gnome'
)
options=(!strip)
source=(
    "https://github.com/hiddify/hiddify-next/archive/refs/tags/${pkgver}.zip"
    "https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_3.13.9-stable.tar.xz"
)
sha256sums=(
    "SKIP"
    "b6bc6f93423488c67110e0fe56523cd2260f3a4c379ed015cd1c7fab66362739"
)
_install_path="/opt/$pkgname"

prepare() {
    export PATH="$PATH:${srcdir}/flutter/bin"
    cd "${srcdir}/hiddify-next-${pkgver//v/}"
    flutter precache
    dart pub global activate flutter_distributor
    export PATH="$PATH":"$HOME/.pub-cache/bin"
    export CHANNEL=prod
}

build() {
    cd "${srcdir}/hiddify-next-${pkgver//v/}"
    make get-geo-assets
    make get
    make translate
    make gen
    make linux-libs
    make linux-release
    ls -R dist/
    mkdir tmp_out
    EXT="AppImage"
    mv dist/*/*.$EXT tmp_out/hiddify-linux-x64.$EXT
    chmod a+x tmp_out/hiddify-linux-x64.$EXT
    cd tmp_out
    ./hiddify-linux-x64.AppImage --appimage-extract > /dev/null
    sed -i 's/Exec=/EXEC=env /' "./squashfs-root/${pkgname}.desktop"
}


package() {
    install -Dm755 "${srcdir}/${pkgname}-next-${pkgver//v/}/tmp_out/hiddify-linux-x64.AppImage" "${pkgdir}/${_install_path}/${pkgname}.AppImage"
    
    install -Dm644 "${srcdir}/${pkgname}-next-${pkgver//v/}/tmp_out/squashfs-root/hiddify.desktop" "$pkgdir/usr/share/applications/${pkgname}.desktop"
    
    for _icons in 128x128 256x256;do
        install -Dm644 "${srcdir}/${pkgname}-next-${pkgver//v/}/tmp_out/squashfs-root/usr/share/icons/hicolor/${_icons}/apps/hiddify.png" "${pkgdir}/usr/share/icons/hicolor/${_icons}/apps/${_pkgname}.png"
    done
    
    install -dm755 "${pkgdir}/usr/bin"
    ln -s "/opt/${pkgname}/${pkgname}.AppImage" "${pkgdir}/usr/bin/${pkgname}"
}